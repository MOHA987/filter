import os, re
import telebot

# ===== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ© (Ø³Ù†Ø¶Ø¨Ø·Ù‡Ø§ ÙÙŠ Render Ù„Ø§Ø­Ù‚Ù‹Ø§) =====
TOKEN = os.getenv("TELEGRAM_TOKEN")
# Ø£Ø­Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±ÙŠÙ† ÙŠÙƒÙÙŠ: Ø¥Ù…Ù‘Ø§ Ø¢ÙŠØ¯ÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø®Ø§ØµØ© Ø£Ùˆ ÙŠÙˆØ²Ø±Ù†ÙŠÙ… Ù‚Ù†Ø§Ø© Ø¹Ø§Ù…Ø©
SOURCE_CHANNEL_ID = os.getenv("SOURCE_CHANNEL_ID")        # Ù…Ø«Ø§Ù„: -1002304674709
SOURCE_CHANNEL_USERNAME = os.getenv("SOURCE_CHANNEL_USERNAME")  # Ù…Ø«Ø§Ù„: FilterZoneSignals (Ø¨Ø¯ÙˆÙ† @)
TARGET_CHANNEL = os.getenv("TARGET_CHANNEL")              # Ù…Ø«Ø§Ù„: @FilterZoneCrypto

MIN_LIQ = float(os.getenv("MIN_LIQUIDITY", 3000))        # Ø£Ù‚Ù„ Ø³ÙŠÙˆÙ„Ø© Ù…Ù‚Ø¨ÙˆÙ„Ø©
MAX_MC  = float(os.getenv("MAX_MARKETCAP", 350000))      # Ø£Ø¹Ù„Ù‰ Ù…Ø§Ø±ÙƒØª ÙƒØ§Ø¨
MAX_AGE = int(os.getenv("MAX_AGE_MINUTES", 40))          # Ø£Ù‚ØµÙ‰ Ø¹Ù…Ø± Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚

bot = telebot.TeleBot(TOKEN, parse_mode="HTML")

# ===== Ø£Ø¯ÙˆØ§Øª parsing Ù„Ù„Ø£Ø±Ù‚Ø§Ù… (ØªØ¯Ø¹Ù… K Ùˆ M) =====
def to_number(num_str, suffix=None):
    n = float(num_str.replace(",", ""))
    if suffix:
        s = suffix.upper()
        if s == "K": n *= 1_000
        elif s == "M": n *= 1_000_000
    return n

def extract_fields(text):
    # Market Cap: $156,723 Ø£Ùˆ $49.4K Ø£Ùˆ $1.2M
    m_mc = re.search(r"Market\s*Cap[:\s]*\$?([\d.,]+)\s*([kKmM])?", text, re.I)
    m_liq = re.search(r"Liquidity[:\s]*\$?([\d.,]+)\s*([kKmM])?", text, re.I)
    m_age = re.search(r"Age[:\s]*([0-9]+)\s*m", text, re.I)

    mc  = to_number(m_mc.group(1), m_mc.group(2)) if m_mc else 0
    liq = to_number(m_liq.group(1), m_liq.group(2)) if m_liq else 0
    age = int(m_age.group(1)) if m_age else 9999
    return mc, liq, age

def is_from_source(chat):
    # Ù‚Ø¨ÙˆÙ„ Ø¥Ù…Ù‘Ø§ Ø¨Ø§Ù„Ù…ÙØ¹Ø±Ù‘Ù Ø§Ù„Ø±Ù‚Ù…ÙŠ Ø£Ùˆ Ø¨Ø§Ù„ÙŠÙˆØ²Ø±Ù†ÙŠÙ…
    ok_id = False
    if SOURCE_CHANNEL_ID:
        try:
            ok_id = (chat.id == int(SOURCE_CHANNEL_ID))
        except:
            ok_id = False
    ok_username = False
    if SOURCE_CHANNEL_USERNAME and chat.username:
        ok_username = (chat.username.lower() == SOURCE_CHANNEL_USERNAME.lower().lstrip("@"))
    return ok_id or ok_username

# ===== Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª =====
@bot.channel_post_handler(func=lambda m: True)
def handle_channel_post(message):
    if not is_from_source(message.chat):
        return

    text = (message.text or message.caption or "")
    mc, liq, age = extract_fields(text)

    if liq >= MIN_LIQ and mc <= MAX_MC and age <= MAX_AGE:
        out = (
            "âœ… <b>Filtered Coin</b>\n"
            f"{text}\n\n"
            f"<i>mc={int(mc)}, liq={int(liq)}, age={age}m</i>"
        )
        bot.send_message(TARGET_CHANNEL, out)
        print(f"âœ… sent | mc={mc} liq={liq} age={age}")
    else:
        print(f"âŒ skip | mc={mc} liq={liq} age={age}")

print("ğŸ¤– Bot is runningâ€¦")
bot.infinity_polling(skip_pending=True)